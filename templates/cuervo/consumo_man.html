{% extends "base.html" %}
{% block stylesheets %}
 <link href="/static/css/forms.css" rel="stylesheet">
{% endblock stylesheets %}

{% block content %}

<form role="form" method="post" action="" style="margin-left: 250px; padding-right: 190px" enctype="multipart/form-data">
  {% csrf_token %}

     {% if msg %}
    <h2 class="text-danger">{{ msg | safe }}</h2>
    {% else %}
    <h2>Asignacion de Lotes Granel <span class="btn btn-info btn-sm" data-toggle="modal" data-target="#instruccionesModal">?</span></h2>
    {% endif %}
    <div class="container">
        <div class="user-box">
            {{ form.ordenproduccion }}
            <label>Orden de produccion</label>
        </div>

        <button type="submit" name="buscar" class="button"> BUSCAR </button>

        {% if orden %}
        <h3 style="color: white">DATOS DE LA ORDEN</h3>
        <table class="table" style="color: white">
            <thead style="background-color: #1e264e; color: white">
                <tr>
                    <th scope="col">Orden</th>
                    <th scope="col">SKU</th>
                    <th scope="col">Descripcion SKU</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>{{ orden.uniqueid }}</td>
                    <td>{{ orden.FK_sku_id.sku }}</td>
                    <td>{{ orden.FK_sku_id.description }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    <br>
    {% if orden.status == 'REL' or orden.status == 'CRTD' %}
    <div class="container">
    <h3 style="color: white">LOTES GRANEL</h3>
    <div>
      <label style="color:white;">Lotes</label>
        {{ form.granel_lot }}
    </div>
        <br>

    <label style="color: white">Folio Inicial</label>
<br>
    <div class="user-box">
    {{ form.folioinicial }}
</div>

    <label style="color: white">Folio Final</label>
<br>
<div class="user-box">
    {{ form.foliofinal }}
</div>
    <button type="submit" name="asignar" class="button"> ASIGNAR </button>
    </div>
    <div class="container">
    <h3 style="color: white">Detalle de Consumo por Lote Granel</h3>
    <table class="table" style="color: white">
        <thead style="background-color: #1e264e; color: white">
            <tr>
                <th>Lote Granel</th>
                <th>Numero de Rollo</th>
                <th>Folio Inicial</th>
                <th>Folio Final</th>
                <th>Cantidad</th>
            </tr>
        </thead>
        <tbody>
            {% for detalle in detalles_consumo %}
            <tr>
                <td>{{ detalle.FK_granel_lot.granel_lot }}</td>  <!-- Accede al nombre del lote granel -->
                <td>{{ detalle.FK_coil.numrollo }}</td>
                <td>{{ detalle.folio_inicial }}</td>
                <td>{{ detalle.folio_final }}</td>
                <td>{{ detalle.cantidad }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div id="confirmarModal" class="modal-custom" style="display: {{ confirmalert }}">
  <div class="modal-content-custom">
    <span class="close-custom" onclick="closeModal()">&times;</span>
    <h2>Confirmar Asignacion</h2>
      {% if data_to_confirm %}
    <p>Orden: {{ data_to_confirm.orden }}</p>
    <p>Lote Granel: {{ data_to_confirm.lote_granel }}</p>
    <p>Folio Inicial: {{ data_to_confirm.folio_inicial }}</p>
    <p>Folio Final: {{ data_to_confirm.folio_final }}</p>
    <p>Cantidad: {{ data_to_confirm.cantidad }}</p>
    {% endif %}
    <form method="post" action="">
      {% csrf_token %}
      <button type="submit" class="button" name="confirmar_asignacion"> Confirmar </button>
      <button type="button" class="button" onclick="closeModal()">Cancelar</button>
    </form>
  </div>
</div>
    {% endif %}
    {% endif %}
  </form>

<!-- Modal -->
<div class="modal fade" id="instruccionesModal" tabindex="-1" aria-labelledby="instruccionesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="instruccionesModalLabel">Instrucciones</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p><b>Objetivo:</b> Realizar el consumo de marbetes en tiempo real en su respectivo lote granel.</p>
		<p><b>Requisitos:</b> Escáner manual. Lote(s) granel de la orden de producción registrados, se carga previamente en el área de procesos.</p>
                <p><b>IMPORTANTE:</b> El rango que se escanee se va a registrar como consumo cuando se seleccione el lote granel.</p>
		<p><b>Paso 1:</b> Ingresar la orden de producción a la que se le desea solicitar bobinas.</p>
                <p><b>Paso 2:</b> Desplegar los lotes granel y validar si hay registrados para realizar el consumo.</p>
                <p><b>Paso 3:</b> Seleccionar el debido lote granel.</p>
                <p><b>Paso 4:</b> Dar clic en el campo de escritura “Folio inicial”.</p>
                <p><b>Paso 5:</b> Escanear el primer marbete que se registrará en el lote granel, se escribirá la URL en el campo.</p>
                <p><b>Paso 6:</b> Dar clic en el campo de escritura “Folio final”. </p>
                <p><b>Paso 7:</b> Escanear el último marbete que se registrará en el lote granel, se escribirá la url en el campo.</p>
                <p><b>Paso 8:</b> Dar clic en “Asignar”, saltará una alerta con los datos del consumo.</p>
                <p><b>Paso 9:</b> Si el consumo es correcto dar clic en “confirmar”.</p>
                <p><b>Paso 10:</b> Esperar a que se ejecute el consumo en el sistema, cuando termine te arrojará una alerta que indique que se realizó el consumo. 
		Visualizar el detalle en la parte inferior.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        var folioInicial = document.getElementById("folioinicial");
        var folioFinal = document.getElementById("foliofinal");

        var preventEnter = function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
            }
        };

        if (folioInicial) {
            folioInicial.addEventListener("keydown", preventEnter);
        }

        if (folioFinal) {
            folioFinal.addEventListener("keydown", preventEnter);
        }
    });

function closeModal() {
    document.getElementById("confirmarModal").style.display = "none";
}
</script>
{% endblock scripts %}

<style>
.modal-custom {
  display: none;
  position: fixed;
  z-index: 1;
  padding-top: 100px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
  margin-left: 200px;
  padding-right: 200px;
}

.modal-content-custom {
  background-color: #000000; /* Fondo negro */
  margin: auto;
  padding: 20px;
  border: 2px solid #FFD700; /* Borde amarillo */
  width: 80%;
  color: #FFFFFF; /* Texto blanco */
}

.close-custom {
  color: #FFD700; /* Color del botn de cerrar */
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #FFFFFF; /* Color del botn de cerrar al pasar el mouse */
  text-decoration: none;
  cursor: pointer;
}

#loadingIndicator {
    text-align: center;
}
</style>
{% endblock content %}
